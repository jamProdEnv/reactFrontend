############################################
# HTTP â†’ HTTPS
############################################
server {
    listen 80;
    server_name wsjr.app wsjr.net wsjr.info wsjr.shop wsjr.store;
    return 301 https://$host$request_uri;
}

############################################
# HTTPS SERVER
############################################
server {
    listen 443 ssl http2;
    server_name wsjr.app wsjr.net wsjr.info wsjr.shop wsjr.store;

    ssl_certificate     /etc/letsencrypt/live/wsjr.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wsjr.app/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    root /usr/share/nginx/html;
    index index.html;

    ########################################
    # OBFUSCATED EXTERNAL API PATHS
    ########################################

    # ------------------ ADMIN SIGNUP ------------------
    # External: /A1B2C3/__admin__/{id}/X9Y8
    location ~ ^/A1B2C3/__admin__/([A-Za-z0-9_-]+)/X9Y8$ {
        rewrite ^ /api/v1/admin/signup/$1 break;
        proxy_pass http://node-server:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------ ADMIN LOGIN ------------------
    # External: /L9M8N7/__login__/{id}/P0Q1
    location ~ ^/L9M8N7/__login__/([A-Za-z0-9_-]+)/P0Q1$ {
        rewrite ^ /api/v1/admin/login/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ GET ADMIN INFO ------------------
    # External: /Z7X6Y5/admin/{id}/R8T9
    location ~ ^/Z7X6Y5/admin/([A-Za-z0-9_-]+)/R8T9$ {
        rewrite ^ /api/v1/admin/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ GET ADMINS LIST ------------------
    # External: /Q1W2E3/__admins__/L4K5
    location = /Q1W2E3/__admins__/L4K5 {
        rewrite ^ /api/v1/admin/admins break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ CREATE POST ------------------
    # External: /P0O9I8/__create__/{id}/U7Y6
    location ~ ^/P0O9I8/__create__/([A-Za-z0-9_-]+)/U7Y6$ {
        rewrite ^ /api/v1/post/createPost/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ GET POSTS ------------------
    # External: /R5T6Y7/__posts__/V8B9
    location = /R5T6Y7/__posts__/V8B9 {
        rewrite ^ /api/v1/posts break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ USER SIGNUP ------------------
    # External: /X1C2V3/__signup__/{id}/M4N5
    location ~ ^/X1C2V3/__signup__/([A-Za-z0-9_-]+)/M4N5$ {
        rewrite ^ /api/v1/user/signup/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ USER LOGIN ------------------
    # External: /B7N8M9/__login__/{id}/K1L2
    location ~ ^/B7N8M9/__login__/([A-Za-z0-9_-]+)/K1L2$ {
        rewrite ^ /api/v1/user/login/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ GET USER INFO ------------------
    # External: /H3J4K5/user/{id}/F6G7
    location ~ ^/H3J4K5/user/([A-Za-z0-9_-]+)/F6G7$ {
        rewrite ^ /api/v1/user/$1 break;
        proxy_pass http://node-server:3000;
    }

    # ------------------ GET USERS LIST ------------------
    # External: /T8Y9U0/__users__/I1O2
    location = /T8Y9U0/__users__/I1O2 {
        rewrite ^ /api/v1/users break;
        proxy_pass http://node-server:3000;
    }

    ########################################
    # SOCKET.IO
    ########################################
    location /socket.io/ {
        proxy_pass http://node-server:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    ########################################
    # GENERIC API FALLBACK (OPTIONAL)
    ########################################
    location /api/ {
        proxy_pass http://node-server:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    ########################################
    # SPA FRONTEND (LAST)
    ########################################
    location / {
        try_files $uri $uri/ /index.html;
    }

    ########################################
    # SECURITY HEADERS
    ########################################
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}
